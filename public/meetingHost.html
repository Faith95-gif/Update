<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Call - Host</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/meetingHost.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="video-call-app">
        <!-- Video Container -->
        <div class="video-container sidebar-view" id="videoContainer">
            <!-- Main Video Section -->
            <div class="main-video-section" id="mainVideoSection">
                <div class="video-wrapper main-video" id="mainVideo">
                    <video class="video-frame" id="mainVideoElement" autoplay playsinline muted></video>
                    <div class="participant-name" id="mainVideoName">You</div>
                    <div class="video-label" id="mainVideoLabel" style="display: none;">
                        <i class="fas fa-desktop"></i>
                        Screen Share
                    </div>
                </div>
            </div>

            <!-- Secondary Videos Section -->
            <div class="secondary-videos-section" id="secondaryVideosSection">
                <!-- Participant videos will be added here dynamically -->
            </div>
        </div>

        <!-- Taskbar -->
        <div class="taskbar">
            <div class="taskbar-left">
                <div class="meeting-info">
                    <h2 class="meeting-title" id="meetingTitle" onclick="editMeetingName()">Loading...</h2>
                    <span class="meeting-time" id="meetingTime">00:00</span>
                </div>
            </div>
            
            <div class="taskbar-center">
                <button class="control-btn" id="micBtn" data-active="true" onclick="toggleMicrophone()">
                    <i class="fas fa-microphone"></i>
                </button>
                
                <button class="control-btn" id="cameraBtn" data-active="true" onclick="toggleCamera()">
                    <i class="fas fa-video"></i>
                </button>
                
                <button class="control-btn" id="screenShareBtn" data-active="false" onclick="toggleScreenShare(this)">
                    <i class="fas fa-desktop"></i>
                </button>
                
                <button class="control-btn participants-btn" id="participantsBtn" onclick="toggleParticipantsPanel()">
                    <i class="fas fa-users"></i>
                    <span class="participant-count" id="participantCount">1</span>
                </button>
                
                <button class="control-btn" id="chatBtn" onclick="toggleChat()">
                    <i class="fas fa-comment"></i>
                </button>
                
                <button class="control-btn" id="reactionBtn" onclick="toggleReactions()">
                    <i class="fas fa-smile"></i>
                </button>
                
                <button class="control-btn end-call-btn" onclick="endMeeting()">
                    <i class="fas fa-phone-slash"></i>
                </button>
            </div>
            
            <div class="taskbar-right">
                <button class="view-toggle-btn" id="viewToggle" onclick="toggleView()">
                    <i class="fas fa-th" id="viewToggleIcon"></i>
                    <span id="viewToggleText">Grid View</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Participants Panel -->
    <div class="participants-panel" id="participantsPanel">
        <div class="participants-header">
            <h3 class="participants-title">
                <i class="fas fa-users"></i>
                Participants (<span id="participantCountText">1</span>)
            </h3>
            <button class="close-participants" onclick="toggleParticipantsPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="participants-search">
            <input type="text" class="search-input" placeholder="Search participants..." id="participantSearch">
        </div>
        
        <div class="participants-list" id="participantsList">
            <!-- Participants will be added here dynamically -->
        </div>
    </div>

    <!-- Meeting Info Modal -->
    <div class="modal-overlay" id="meetingInfoModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Meeting Information</h3>
                <button class="close-btn" onclick="closeMeetingInfoModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-item">
                    <label>Meeting ID:</label>
                    <div class="meeting-id-display">
                        <span id="displayMeetingId"></span>
                        <button class="copy-btn" onclick="copyMeetingId()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div class="info-item">
                    <label>Join URL:</label>
                    <div class="meeting-id-display">
                        <span id="displayJoinUrl"></span>
                        <button class="copy-btn" onclick="copyJoinUrl()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        class HostMeeting {
            constructor() {
                this.socket = io();
                this.meetingId = this.getMeetingIdFromUrl();
                this.meetingName = this.getMeetingNameFromUrl() || sessionStorage.getItem('customMeetingName') || 'New Meeting';
                this.hostName = '';
                this.participants = [];
                this.localStream = null;
                this.peerConnections = new Map();
                this.isScreenSharing = false;
                this.currentView = 'sidebar';
                this.startTime = new Date();
                
                this.init();
            }

            getMeetingIdFromUrl() {
                const path = window.location.pathname;
                const parts = path.split('/');
                return parts[parts.length - 1];
            }

            getMeetingNameFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('name');
            }

            async init() {
                try {
                    await this.getUserInfo();
                    await this.initializeMedia();
                    this.setupSocketListeners();
                    this.setupEventListeners();
                    this.joinAsHost();
                    this.startMeetingTimer();
                    this.updateMeetingTitle();
                    
                    // Check for auto screen share
                    const autoScreenShare = new URLSearchParams(window.location.search).get('autoScreenShare') === 'true' ||
                                           sessionStorage.getItem('autoStartScreenShare') === 'true';
                    
                    if (autoScreenShare) {
                        setTimeout(() => {
                            this.startScreenShare();
                        }, 2000); // Wait 2 seconds for everything to initialize
                    }
                    
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.showToast('Failed to initialize meeting', 'error');
                }
            }

            async getUserInfo() {
                try {
                    const response = await fetch('/api/user');
                    const data = await response.json();
                    if (data.user) {
                        this.hostName = data.user.name;
                    } else {
                        window.location.href = '/login';
                    }
                } catch (error) {
                    console.error('Error fetching user data:', error);
                    window.location.href = '/login';
                }
            }

            async initializeMedia() {
                try {
                    const constraints = {
                        video: {
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    };

                    this.localStream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    const mainVideoElement = document.getElementById('mainVideoElement');
                    mainVideoElement.srcObject = this.localStream;
                    
                    // Check if video should be off by default
                    if (sessionStorage.getItem('autoStopVideo') === 'true') {
                        this.toggleCamera();
                        sessionStorage.removeItem('autoStopVideo');
                    }
                    
                } catch (error) {
                    console.error('Error accessing media devices:', error);
                    this.showToast('Failed to access camera/microphone', 'error');
                }
            }

            setupSocketListeners() {
                this.socket.on('participant-joined', (data) => {
                    this.addParticipant(data.participant);
                    this.showToast(`${data.participant.name} joined the meeting`, 'info');
                });

                this.socket.on('participant-left', (data) => {
                    this.removeParticipant(data.participantId);
                    this.showToast(`${data.participantName} left the meeting`, 'info');
                });

                this.socket.on('meeting-info', (data) => {
                    this.meetingName = data.meetingName;
                    this.updateMeetingTitle();
                    this.participants = data.participants || [];
                    this.updateParticipantsList();
                });

                this.socket.on('meeting-name-updated', (data) => {
                    this.meetingName = data.meetingName;
                    this.updateMeetingTitle();
                });

                // WebRTC signaling
                this.socket.on('offer', (data) => {
                    this.handleOffer(data.offer, data.sender);
                });

                this.socket.on('answer', (data) => {
                    this.handleAnswer(data.answer, data.sender);
                });

                this.socket.on('ice-candidate', (data) => {
                    this.handleIceCandidate(data.candidate, data.sender);
                });
            }

            setupEventListeners() {
                // Meeting title click to edit
                document.getElementById('meetingTitle').addEventListener('click', () => {
                    this.editMeetingName();
                });
            }

            joinAsHost() {
                this.socket.emit('join-as-host', {
                    meetingId: this.meetingId,
                    hostName: this.hostName,
                    meetingName: this.meetingName,
                    options: {
                        autoStartScreenShare: sessionStorage.getItem('autoStartScreenShare') === 'true'
                    }
                });
            }

            updateMeetingTitle() {
                const titleElement = document.getElementById('meetingTitle');
                if (titleElement) {
                    titleElement.textContent = this.meetingName;
                }
            }

            editMeetingName() {
                const currentName = this.meetingName;
                const newName = prompt('Enter new meeting name:', currentName);
                
                if (newName && newName.trim() !== '' && newName.trim() !== currentName) {
                    this.meetingName = newName.trim();
                    this.updateMeetingTitle();
                    
                    // Update on server and notify all participants
                    this.socket.emit('update-meeting-name', {
                        meetingId: this.meetingId,
                        newName: this.meetingName
                    });
                    
                    this.showToast('Meeting name updated', 'success');
                }
            }

            async startScreenShare() {
                try {
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: true,
                        audio: true
                    });

                    // Replace video track
                    const videoTrack = screenStream.getVideoTracks()[0];
                    const sender = this.peerConnections.get('screen')?.getSenders()?.find(s => 
                        s.track && s.track.kind === 'video'
                    );

                    if (sender) {
                        await sender.replaceTrack(videoTrack);
                    }

                    // Update local video
                    const mainVideoElement = document.getElementById('mainVideoElement');
                    mainVideoElement.srcObject = screenStream;

                    // Show screen share label
                    const screenLabel = document.getElementById('mainVideoLabel');
                    if (screenLabel) {
                        screenLabel.style.display = 'flex';
                    }

                    this.isScreenSharing = true;
                    const screenShareBtn = document.getElementById('screenShareBtn');
                    screenShareBtn.setAttribute('data-active', 'true');

                    // Notify participants
                    this.socket.emit('start-screen-share', {
                        meetingId: this.meetingId
                    });

                    this.showToast('Screen sharing started', 'success');

                    // Handle screen share end
                    videoTrack.onended = () => {
                        this.stopScreenShare();
                    };

                } catch (error) {
                    console.error('Error starting screen share:', error);
                    this.showToast('Failed to start screen sharing', 'error');
                }
            }

            async stopScreenShare() {
                try {
                    // Get camera stream back
                    const cameraStream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });

                    // Replace with camera
                    const videoTrack = cameraStream.getVideoTracks()[0];
                    const sender = this.peerConnections.get('camera')?.getSenders()?.find(s => 
                        s.track && s.track.kind === 'video'
                    );

                    if (sender) {
                        await sender.replaceTrack(videoTrack);
                    }

                    // Update local video
                    const mainVideoElement = document.getElementById('mainVideoElement');
                    mainVideoElement.srcObject = cameraStream;

                    // Hide screen share label
                    const screenLabel = document.getElementById('mainVideoLabel');
                    if (screenLabel) {
                        screenLabel.style.display = 'none';
                    }

                    this.isScreenSharing = false;
                    const screenShareBtn = document.getElementById('screenShareBtn');
                    screenShareBtn.setAttribute('data-active', 'false');

                    // Notify participants
                    this.socket.emit('stop-screen-share', {
                        meetingId: this.meetingId
                    });

                    this.showToast('Screen sharing stopped', 'info');

                } catch (error) {
                    console.error('Error stopping screen share:', error);
                    this.showToast('Failed to stop screen sharing', 'error');
                }
            }

            addParticipant(participant) {
                this.participants.push(participant);
                this.updateParticipantsList();
                this.updateParticipantCount();
            }

            removeParticipant(participantId) {
                this.participants = this.participants.filter(p => p.id !== participantId);
                this.updateParticipantsList();
                this.updateParticipantCount();
            }

            updateParticipantsList() {
                const participantsList = document.getElementById('participantsList');
                if (!participantsList) return;

                const html = this.participants.map(participant => `
                    <div class="participant-item" data-participant-id="${participant.id}">
                        <div class="participant-avatar">${this.getInitials(participant.name)}</div>
                        <div class="participant-info">
                            <div class="participant-name">${participant.name}</div>
                            <div class="participant-role">
                                <span class="role-badge participant">Participant</span>
                            </div>
                        </div>
                        <div class="participant-status">
                            <div class="status-icon speaking"></div>
                        </div>
                        <div class="participant-actions">
                            <button class="participant-menu-btn" onclick="toggleParticipantMenu('${participant.id}')">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        </div>
                    </div>
                `).join('');

                participantsList.innerHTML = html;
            }

            updateParticipantCount() {
                const totalCount = this.participants.length + 1; // +1 for host
                document.getElementById('participantCount').textContent = totalCount;
                document.getElementById('participantCountText').textContent = totalCount;
            }

            getInitials(name) {
                return name.split(' ').map(part => part[0]).join('').toUpperCase().substring(0, 2);
            }

            startMeetingTimer() {
                setInterval(() => {
                    const now = new Date();
                    const elapsed = now - this.startTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    
                    const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    document.getElementById('meetingTime').textContent = timeString;
                }, 1000);
            }

            showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type} show`;
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            // WebRTC methods (simplified for this example)
            async handleOffer(offer, senderId) {
                // Handle WebRTC offer
            }

            async handleAnswer(answer, senderId) {
                // Handle WebRTC answer
            }

            async handleIceCandidate(candidate, senderId) {
                // Handle ICE candidate
            }
        }

        // Global functions
        function toggleMicrophone() {
            const micBtn = document.getElementById('micBtn');
            const isActive = micBtn.getAttribute('data-active') === 'true';
            
            if (window.hostMeeting && window.hostMeeting.localStream) {
                const audioTrack = window.hostMeeting.localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    micBtn.setAttribute('data-active', audioTrack.enabled);
                    
                    const icon = micBtn.querySelector('i');
                    icon.className = audioTrack.enabled ? 'fas fa-microphone' : 'fas fa-microphone-slash';
                }
            }
        }

        function toggleCamera() {
            const cameraBtn = document.getElementById('cameraBtn');
            const isActive = cameraBtn.getAttribute('data-active') === 'true';
            
            if (window.hostMeeting && window.hostMeeting.localStream) {
                const videoTrack = window.hostMeeting.localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    cameraBtn.setAttribute('data-active', videoTrack.enabled);
                    
                    const icon = cameraBtn.querySelector('i');
                    icon.className = videoTrack.enabled ? 'fas fa-video' : 'fas fa-video-slash';
                }
            }
        }

        function toggleScreenShare(button) {
            if (window.hostMeeting) {
                const isActive = button.getAttribute('data-active') === 'true';
                
                if (isActive) {
                    window.hostMeeting.stopScreenShare();
                } else {
                    window.hostMeeting.startScreenShare();
                }
            }
        }

        function toggleParticipantsPanel() {
            const panel = document.getElementById('participantsPanel');
            const container = document.getElementById('videoContainer');
            
            panel.classList.toggle('open');
            container.classList.toggle('participants-open');
        }

        function toggleView() {
            const container = document.getElementById('videoContainer');
            const toggleBtn = document.getElementById('viewToggle');
            const icon = document.getElementById('viewToggleIcon');
            const text = document.getElementById('viewToggleText');
            
            if (window.hostMeeting) {
                if (window.hostMeeting.currentView === 'sidebar') {
                    window.hostMeeting.currentView = 'grid';
                    container.classList.remove('sidebar-view');
                    container.classList.add('grid-view');
                    icon.className = 'fas fa-columns';
                    text.textContent = 'Sidebar View';
                } else {
                    window.hostMeeting.currentView = 'sidebar';
                    container.classList.remove('grid-view');
                    container.classList.add('sidebar-view');
                    icon.className = 'fas fa-th';
                    text.textContent = 'Grid View';
                }
            }
        }

        function editMeetingName() {
            if (window.hostMeeting) {
                window.hostMeeting.editMeetingName();
            }
        }

        function endMeeting() {
            if (confirm('Are you sure you want to end this meeting for everyone?')) {
                if (window.hostMeeting) {
                    window.hostMeeting.socket.emit('end-meeting', {
                        meetingId: window.hostMeeting.meetingId
                    });
                }
                window.location.href = '/dashboard';
            }
        }

        function copyMeetingId() {
            if (window.hostMeeting) {
                navigator.clipboard.writeText(window.hostMeeting.meetingId).then(() => {
                    window.hostMeeting.showToast('Meeting ID copied to clipboard', 'success');
                });
            }
        }

        function copyJoinUrl() {
            if (window.hostMeeting) {
                const joinUrl = `${window.location.origin}/join/${window.hostMeeting.meetingId}`;
                navigator.clipboard.writeText(joinUrl).then(() => {
                    window.hostMeeting.showToast('Join URL copied to clipboard', 'success');
                });
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.hostMeeting = new HostMeeting();
        });
    </script>
</body>
</html>