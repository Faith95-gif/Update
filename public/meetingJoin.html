<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Call - Join Meeting</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/meetingJoin.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="video-call-app">
        <!-- Video Container -->
        <div class="video-container sidebar-view" id="videoContainer">
            <!-- Main Video Section -->
            <div class="main-video-section" id="mainVideoSection">
                <div class="video-wrapper main-video" id="mainVideo">
                    <video class="video-frame" id="mainVideoElement" autoplay playsinline muted></video>
                    <div class="participant-name" id="mainVideoName">You</div>
                </div>
            </div>

            <!-- Secondary Videos Section -->
            <div class="secondary-videos-section" id="secondaryVideosSection">
                <!-- Participant videos will be added here dynamically -->
            </div>
        </div>

        <!-- Taskbar -->
        <div class="taskbar">
            <div class="taskbar-left">
                <div class="meeting-info">
                    <h2 class="meeting-title" id="meetingTitle">Loading...</h2>
                    <span class="meeting-time" id="meetingTime">00:00</span>
                </div>
            </div>
            
            <div class="taskbar-center">
                <button class="control-btn" id="micBtn" data-active="true" onclick="toggleMicrophone()">
                    <i class="fas fa-microphone"></i>
                </button>
                
                <button class="control-btn" id="cameraBtn" data-active="true" onclick="toggleCamera()">
                    <i class="fas fa-video"></i>
                </button>
                
                <button class="control-btn" id="screenShareBtn" data-active="false" onclick="toggleScreenShare(this)">
                    <i class="fas fa-desktop"></i>
                </button>
                
                <button class="control-btn participants-btn" id="participantsBtn" onclick="toggleParticipantsPanel()">
                    <i class="fas fa-users"></i>
                    <span class="participant-count" id="participantCount">1</span>
                </button>
                
                <button class="control-btn" id="chatBtn" onclick="toggleChat()">
                    <i class="fas fa-comment"></i>
                </button>
                
                <button class="control-btn" id="reactionBtn" onclick="toggleReactions()">
                    <i class="fas fa-smile"></i>
                </button>
                
                <button class="control-btn end-call-btn" onclick="leaveMeeting()">
                    <i class="fas fa-phone-slash"></i>
                </button>
            </div>
            
            <div class="taskbar-right">
                <button class="view-toggle-btn" id="viewToggle" onclick="toggleView()">
                    <i class="fas fa-th" id="viewToggleIcon"></i>
                    <span id="viewToggleText">Grid View</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Participants Panel -->
    <div class="participants-panel" id="participantsPanel">
        <div class="participants-header">
            <h3 class="participants-title">
                <i class="fas fa-users"></i>
                Participants (<span id="participantCountText">1</span>)
            </h3>
            <button class="close-participants" onclick="toggleParticipantsPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="participants-search">
            <input type="text" class="search-input" placeholder="Search participants..." id="participantSearch">
        </div>
        
        <div class="participants-list" id="participantsList">
            <!-- Participants will be added here dynamically -->
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        class ParticipantMeeting {
            constructor() {
                this.socket = io();
                this.meetingId = this.getMeetingIdFromUrl();
                this.participantName = '';
                this.meetingName = 'Meeting';
                this.participants = [];
                this.localStream = null;
                this.peerConnections = new Map();
                this.currentView = 'sidebar';
                this.joinTime = new Date();
                
                this.init();
            }

            getMeetingIdFromUrl() {
                const path = window.location.pathname;
                const parts = path.split('/');
                return parts[parts.length - 1];
            }

            async init() {
                try {
                    await this.getUserInfo();
                    await this.initializeMedia();
                    this.setupSocketListeners();
                    this.setupEventListeners();
                    this.joinAsParticipant();
                    this.startMeetingTimer();
                    
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.showToast('Failed to initialize meeting', 'error');
                }
            }

            async getUserInfo() {
                try {
                    const response = await fetch('/api/user');
                    const data = await response.json();
                    if (data.user) {
                        this.participantName = data.user.name;
                    } else {
                        window.location.href = '/login';
                    }
                } catch (error) {
                    console.error('Error fetching user data:', error);
                    window.location.href = '/login';
                }
            }

            async initializeMedia() {
                try {
                    const constraints = {
                        video: {
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    };

                    this.localStream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    const mainVideoElement = document.getElementById('mainVideoElement');
                    mainVideoElement.srcObject = this.localStream;
                    
                } catch (error) {
                    console.error('Error accessing media devices:', error);
                    this.showToast('Failed to access camera/microphone', 'error');
                }
            }

            setupSocketListeners() {
                this.socket.on('participant-joined', (data) => {
                    this.addParticipant(data.participant);
                    this.showToast(`${data.participant.name} joined the meeting`, 'info');
                });

                this.socket.on('participant-left', (data) => {
                    this.removeParticipant(data.participantId);
                    this.showToast(`${data.participantName} left the meeting`, 'info');
                });

                this.socket.on('meeting-info', (data) => {
                    this.meetingName = data.meetingName;
                    this.updateMeetingTitle();
                    this.participants = data.participants || [];
                    this.updateParticipantsList();
                });

                this.socket.on('meeting-name-updated', (data) => {
                    this.meetingName = data.meetingName;
                    this.updateMeetingTitle();
                    this.showToast('Meeting name updated', 'info');
                });

                this.socket.on('host-disconnected', () => {
                    this.showToast('Host has left the meeting', 'warning');
                });

                // WebRTC signaling
                this.socket.on('offer', (data) => {
                    this.handleOffer(data.offer, data.sender);
                });

                this.socket.on('answer', (data) => {
                    this.handleAnswer(data.answer, data.sender);
                });

                this.socket.on('ice-candidate', (data) => {
                    this.handleIceCandidate(data.candidate, data.sender);
                });

                this.socket.on('screen-share-started', (data) => {
                    this.showToast(`${data.participantName} started screen sharing`, 'info');
                });

                this.socket.on('screen-share-stopped', (data) => {
                    this.showToast('Screen sharing stopped', 'info');
                });
            }

            setupEventListeners() {
                // Add any additional event listeners here
            }

            joinAsParticipant() {
                this.socket.emit('join-as-participant', {
                    meetingId: this.meetingId,
                    participantName: this.participantName
                });
            }

            updateMeetingTitle() {
                const titleElement = document.getElementById('meetingTitle');
                if (titleElement) {
                    titleElement.textContent = this.meetingName;
                }
            }

            addParticipant(participant) {
                this.participants.push(participant);
                this.updateParticipantsList();
                this.updateParticipantCount();
            }

            removeParticipant(participantId) {
                this.participants = this.participants.filter(p => p.id !== participantId);
                this.updateParticipantsList();
                this.updateParticipantCount();
            }

            updateParticipantsList() {
                const participantsList = document.getElementById('participantsList');
                if (!participantsList) return;

                const html = this.participants.map(participant => `
                    <div class="participant-item" data-participant-id="${participant.id}">
                        <div class="participant-avatar">${this.getInitials(participant.name)}</div>
                        <div class="participant-info">
                            <div class="participant-name">${participant.name}</div>
                            <div class="participant-role">
                                <span class="role-badge ${participant.isHost ? 'host' : 'participant'}">
                                    ${participant.isHost ? 'Host' : 'Participant'}
                                </span>
                            </div>
                        </div>
                        <div class="participant-status">
                            <div class="status-icon speaking"></div>
                        </div>
                    </div>
                `).join('');

                participantsList.innerHTML = html;
            }

            updateParticipantCount() {
                const totalCount = this.participants.length + 1; // +1 for self
                document.getElementById('participantCount').textContent = totalCount;
                document.getElementById('participantCountText').textContent = totalCount;
            }

            getInitials(name) {
                return name.split(' ').map(part => part[0]).join('').toUpperCase().substring(0, 2);
            }

            startMeetingTimer() {
                setInterval(() => {
                    const now = new Date();
                    const elapsed = now - this.joinTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    
                    const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    document.getElementById('meetingTime').textContent = timeString;
                }, 1000);
            }

            showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type} show`;
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            // WebRTC methods (simplified for this example)
            async handleOffer(offer, senderId) {
                // Handle WebRTC offer
            }

            async handleAnswer(answer, senderId) {
                // Handle WebRTC answer
            }

            async handleIceCandidate(candidate, senderId) {
                // Handle ICE candidate
            }
        }

        // Global functions
        function toggleMicrophone() {
            const micBtn = document.getElementById('micBtn');
            
            if (window.participantMeeting && window.participantMeeting.localStream) {
                const audioTrack = window.participantMeeting.localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    micBtn.setAttribute('data-active', audioTrack.enabled);
                    
                    const icon = micBtn.querySelector('i');
                    icon.className = audioTrack.enabled ? 'fas fa-microphone' : 'fas fa-microphone-slash';
                }
            }
        }

        function toggleCamera() {
            const cameraBtn = document.getElementById('cameraBtn');
            
            if (window.participantMeeting && window.participantMeeting.localStream) {
                const videoTrack = window.participantMeeting.localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    cameraBtn.setAttribute('data-active', videoTrack.enabled);
                    
                    const icon = cameraBtn.querySelector('i');
                    icon.className = videoTrack.enabled ? 'fas fa-video' : 'fas fa-video-slash';
                }
            }
        }

        function toggleScreenShare(button) {
            // Participants typically can't control screen sharing
            window.participantMeeting.showToast('Only the host can control screen sharing', 'warning');
        }

        function toggleParticipantsPanel() {
            const panel = document.getElementById('participantsPanel');
            const container = document.getElementById('videoContainer');
            
            panel.classList.toggle('open');
            container.classList.toggle('participants-open');
        }

        function toggleView() {
            const container = document.getElementById('videoContainer');
            const toggleBtn = document.getElementById('viewToggle');
            const icon = document.getElementById('viewToggleIcon');
            const text = document.getElementById('viewToggleText');
            
            if (window.participantMeeting) {
                if (window.participantMeeting.currentView === 'sidebar') {
                    window.participantMeeting.currentView = 'grid';
                    container.classList.remove('sidebar-view');
                    container.classList.add('grid-view');
                    icon.className = 'fas fa-columns';
                    text.textContent = 'Sidebar View';
                } else {
                    window.participantMeeting.currentView = 'sidebar';
                    container.classList.remove('grid-view');
                    container.classList.add('sidebar-view');
                    icon.className = 'fas fa-th';
                    text.textContent = 'Grid View';
                }
            }
        }

        function leaveMeeting() {
            if (confirm('Are you sure you want to leave this meeting?')) {
                if (window.participantMeeting) {
                    window.participantMeeting.socket.emit('leave-meeting', {
                        meetingId: window.participantMeeting.meetingId
                    });
                }
                window.location.href = '/dashboard';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.participantMeeting = new ParticipantMeeting();
        });
    </script>
</body>
</html>